name: Patch APK with ReVanced

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'Прямая ссылка на APK (будет скачано в app.apk)'
        required: true
        default: ''

jobs:
  patch-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl wget

      - name: Download APK with wget
        run: |
          if [ -z "${{ github.event.inputs.url }}" ]; then
            echo "Error: Не указана ссылка на APK (input 'url')."
            exit 1
          fi
          wget -L -O app.apk "${{ github.event.inputs.url }}"

      - name: Verify APK
        run: |
          APK_SIZE=$(stat -c%s app.apk)
          if [ "$APK_SIZE" -lt 10000000 ]; then
            echo "Error: Downloaded file too small ($APK_SIZE bytes), not a real APK."
            exit 1
          fi
          echo "APK downloaded successfully: $APK_SIZE bytes"

      - name: Download ReVanced CLI
        run: |
          CLI_URL=$(curl -s https://api.github.com/repos/ReVanced/revanced-cli/releases/latest | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          curl -L "$CLI_URL" -o revanced-cli.jar

      - name: Download ReVanced Patches
        run: |
          PATCHES_URL=$(curl -s https://api.github.com/repos/krolchonok/revanced-patches/releases/latest | jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')
          curl -L "$PATCHES_URL" -o patches.rvp

      - name: Patch APK
        run: |
          java -jar revanced-cli.jar patch -f -p patches.rvp \
            --exclusive \
            -e "Downloads" \
            -e "SIM spoof" \
            -e "Fix Google login" \
            -e "Disable login requirement" \
            -e "Show seekbar" \
            app.apk

      - name: List files after patch
        run: ls -lh

      - name: Upload Patched APK
        uses: actions/upload-artifact@v4
        with:
          name: titkok-app
          path: "*.apk"

