name: Patch APK with ReVanced

on:
  workflow_dispatch:
    inputs:
      url:
        description: '–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ APK (–±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω–æ –≤ app.apk)'
        required: true
        default: ''

jobs:
  patch-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl wget

      - name: Download APK with wget
        run: |
          if [ -z "${{ github.event.inputs.url }}" ]; then
            echo "Error: –ù–µ —É–∫–∞–∑–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ APK (input 'url')."
            exit 1
          fi
          wget -L -O app.apk "${{ github.event.inputs.url }}"

      - name: Verify APK
        run: |
          APK_SIZE=$(stat -c%s app.apk)
          if [ "$APK_SIZE" -lt 10000000 ]; then
            echo "Error: Downloaded file too small ($APK_SIZE bytes), not a real APK."
            exit 1
          fi
          echo "APK downloaded successfully: $APK_SIZE bytes"

      - name: Download ReVanced CLI
        run: |
          CLI_URL=$(curl -s https://api.github.com/repos/ReVanced/revanced-cli/releases/latest | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')
          curl -L "$CLI_URL" -o revanced-cli.jar

      - name: Download ReVanced Patches
        run: |
          PATCHES_URL=$(curl -s https://api.github.com/repos/krolchonok/revanced-patches/releases/latest | jq -r '.assets[] | select(.name | endswith(".rvp")) | .browser_download_url')
          curl -L "$PATCHES_URL" -o patches.rvp

      - name: Patch APK
        run: |
          java -jar revanced-cli.jar patch -f -p patches.rvp \
            --exclusive \
            -e "Downloads" \
            -e "SIM spoof" \
            -e "Fix Google login" \
            -e "Disable login requirement" \
            -e "Show seekbar" \
            app.apk

      - name: Rename output
        run: mv -v app-patched.apk titkok-app.apk

      - name: Upload Patched APK
        uses: actions/upload-artifact@v4
        with:
          name: titkok-app
          path: titkok-app.apk

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-${{ github.run_number }}-${{ github.run_id }}
          name: "TikTok Patched APK - Auto Release ${{ github.run_number }}"
          body: |
            üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ —Å –ø—Ä–æ–ø–∞—Ç—á–µ–Ω–Ω—ã–º TikTok APK
            
            **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ:**
            - –ò—Å—Ö–æ–¥–Ω—ã–π APK: ${{ github.event.inputs.url }}
            - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${{ github.event.head_commit.timestamp }}
            - Workflow Run: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
            
            **–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
            1. –°–∫–∞—á–∞–π—Ç–µ `titkok-app.apk`
            2. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ APK —Ñ–∞–π–ª
          files: titkok-app.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

